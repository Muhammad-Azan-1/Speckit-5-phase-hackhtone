# API Contract: Chat Endpoint

## Overview
This document specifies the API contract for the chat endpoint that will interact with the Conversation and Message models.

## Endpoint: POST /api/{user_id}/chat

### Description
Stateless chat endpoint that handles natural language requests from the AI chatbot interface. The endpoint validates JWT authentication, manages conversation state in the database, and orchestrates MCP tool calls for task operations.

### Request Parameters
- `user_id` (path): The authenticated user's ID from JWT token (required)

### Request Body
```json
{
  "conversation_id": 123,
  "message": "Add a task to buy groceries"
}
```

**Request Schema:**
```json
{
  "type": "object",
  "properties": {
    "conversation_id": {
      "type": "integer",
      "description": "Optional: ID of existing conversation, creates new if null",
      "minimum": 1
    },
    "message": {
      "type": "string",
      "description": "User's natural language input",
      "minLength": 1,
      "maxLength": 1000
    }
  },
  "required": ["message"],
  "additionalProperties": false
}
```

### Response Schema
```json
{
  "type": "object",
  "properties": {
    "conversation_id": {
      "type": "integer",
      "description": "ID of the conversation (newly created or existing)"
    },
    "response": {
      "type": "string",
      "description": "Assistant's natural language response"
    },
    "tool_calls": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Name of the MCP tool called"
          },
          "arguments": {
            "type": "object",
            "description": "Arguments passed to the tool"
          },
          "result": {
            "type": "object",
            "description": "Result returned by the tool"
          }
        },
        "required": ["name", "arguments"]
      }
    }
  },
  "required": ["conversation_id", "response", "tool_calls"]
}
```

### Example Response
```json
{
  "conversation_id": 123,
  "response": "âœ“ Added 'buy groceries' to your task list. What else can I help with?",
  "tool_calls": [
    {
      "name": "add_task",
      "arguments": {
        "user_id": "user123",
        "title": "buy groceries",
        "description": "",
        "category_id": null
      },
      "result": {
        "task_id": 456,
        "status": "created",
        "title": "buy groceries"
      }
    }
  ]
}
```

### Authentication
- JWT token required in Authorization header: `Authorization: Bearer <token>`
- User ID in URL path must match user ID in JWT token
- Return 401 for invalid/expired tokens
- Return 403 for user ID mismatch

### Error Responses
- `400 Bad Request`: Invalid request body format
- `401 Unauthorized`: Invalid or missing JWT token
- `403 Forbidden`: User ID in URL doesn't match JWT token
- `422 Unprocessable Entity`: Business logic error (e.g., invalid message content)
- `500 Internal Server Error`: Unexpected server error

### Database Operations
1. Validate user_id matches JWT token user_id
2. Fetch/create conversation record from database
3. Fetch message history for conversation
4. Store user's new message in database
5. Process message with AI agent and MCP tools
6. Store assistant's response in database
7. Return response with conversation ID

### Performance Considerations
- Index on user_id for efficient user isolation queries
- Index on conversation_id for conversation lookup
- Limit message history to prevent excessive data transfer
- Cache conversation metadata if needed